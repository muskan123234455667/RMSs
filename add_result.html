{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Add Result | SRMS{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Declare Result</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="POST" class="card p-4 shadow-sm">
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label">Select Class</label>
            <select name="class" id="class_id" class="form-select" required>
                <option value="">-- Select Class --</option>
                {% for cls in classes %}
                    <option value="{{ cls.id }}">{{ cls.class_name }} - {{ cls.section }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Select Student</label>
            <select name="studentid" id="student_id" class="form-select" required>
                <option value="">-- Select Student --</option>
            </select>
        </div>

        <div id="subject_fields">
            <!-- AJAX will fill subject & marks input fields here -->
        </div>

        <button type="submit" name="submit_result" class="btn btn-primary mt-3">Declare Result</button>
    </form>
</div>

<script>
    document.getElementById('class_id').addEventListener('change', function () {
        const classId = this.value;

        if (!classId) return;

        fetch(`/get-students-subjects/?class_id=${classId}`)
            .then(res => res.json())
            .then(data => {
                // Populate students
                const studentSelect = document.getElementById('student_id');
                studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
                data.students.forEach(stu => {
                    const opt = document.createElement('option');
                    opt.value = stu.id;
                    opt.text = `${stu.name} (Roll ID: ${stu.roll_id})`;
                    studentSelect.appendChild(opt);
                });

                // Populate subject input fields
                const subjectFields = document.getElementById('subject_fields');
                subjectFields.innerHTML = '<h5 class="mt-4">Subjects and Marks</h5>';
                data.subjects.forEach(sub => {
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    div.innerHTML = `
                        <label class="form-label">${sub.name}</label>
                        <input type="number" name="marks_${sub.id}" class="form-control" required>
                    `;
                    subjectFields.appendChild(div);
                });
            });
    });
</script>
{% endblock %}
